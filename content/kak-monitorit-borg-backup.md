+++
title = "Как настроить мониторинг для Borg Backup"
description = "Как настроить мониторинг для Borg Backup, с ежедневными отчётами."
date = 2021-03-29

[taxonomies]
tags = ["backup", "borg", "monitoring"]
categories = ["backup", "monitoring"]
+++

Borg — это отличный инструмент для организации резервного копирования в Linux. Мы несколько лет используем его в production.  
Более подробно про Borg в [отдельной статье](https://b.tinyops.ru/linux-backup-with-borg/).

Допустим резервное копирование настроено, запускается из [планировщика cron](/planirovschik-zadanii-cron/) каждый день, в час ночи.
Для обеспечения надежности [необходим мониторинг](/zachem-nuzhen-monitoring/).

Несмотря на то, что cron проверен десятилетиями и зарекомендовал себя как надёжное приложение, на его работу могут повлиять
внешние факторы:

- Обновления операционной системы;
- Работа других приложений;
- Сетевой ресурс для резервных копий более недоступен;
- Закончилось место на жёстком диске;
- Ошибки администратора (человеческий фактор).

В таких случаях поможет [мониторинг cron-задач](https://cp.cronbox.ru).

## Настройка

### Создание монитора

1. [Заходим](https://cp.cronbox.ru) под своей учётной записью в Cronbox

2. Добавляем новый монитор для cron-задачи:  
   ![Добавление нового cron-монитора](/images/backup-borg/borg-backup__add-monitor.png "Добавление нового cron-монитора")
  
3. Указываем название монитора, расписание, идентичное тому по которому запускается borg:  
   ![Форма создания нового монитора](/images/backup-borg/borg-backup__new-monitor-form.png "Форма создания нового монитора")
   
4. Настраиваем условия уведомлений и каналы по которым сервис уведомит нас о задаче:  
   ![Условия и каналы уведомлений](/images/backup-borg/borg-backup__notifications.png "Условия и каналы уведомлений")

5. Нажимаем "Сохранить".

### Интеграция монитора с задачей в cron

Монитор создан. Заходим на страницу монитора, во кладку "Интеграция". Копируем оттуда уникальную ссылку:

![Интеграция монитора и задачи](/images/backup-borg/borg-backup__integration.png "Интеграция монитора и задачи")

Например, `https://p.cronbox.ru/p/3cbaaeb7-5ef2-4a74-8342-528e5f56e6e3`.

На вашем сервере добавляем вызов ссылки после вызова `borg`. Например, вот так:

```
0 3 * * * /root/scripts/borg-backup.sh && curl https://p.cronbox.ru/p/3cbaaeb7-5ef2-4a74-8342-528e5f56e6e3
```

В `03:00` на вашем сервере будет запущен скрипт `/root/scripts/borg-backup.sh`. Если скрипт отработает без ошибок, то
следующей командой будет запущена утилита curl, которая выполнит запрос к уникальной ссылке монитора.

Сервис будет следить чтобы отклик от cron-задачи пришёл вовремя, в противном случае — напишет по почте и/или в Telegram.


